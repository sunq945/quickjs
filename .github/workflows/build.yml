name: Build ESP32-S3 QuickJS Static Library

on:
  pull_request:
    paths:
      - '**'
      - '!.gitignore'
      - '!LICENSE'
      - '!TODO'
      - '!doc/**'
      - '!examples/**'
      - '.github/workflows/build.yml'
  push:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest  # 使用 Ubuntu 系统来运行构建

    steps:
    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install jq git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
        mkdir -p ~/esp
        cd ~/esp/
        release_info=$(curl -s https://api.github.com/repos/espressif/crosstool-NG/releases/latest)
        tag_name=$(echo "$release_info" | jq -r '.tag_name')
        #tag_name="esp-14.2.0_20241119"
        ESP_GNU_TOOLCHAIN_VER=$(echo "${tag_name#*-}"  )
        download_url="https://github.com/espressif/crosstool-NG/releases/download/esp-${ESP_GNU_TOOLCHAIN_VER}/xtensa-esp-elf-${ESP_GNU_TOOLCHAIN_VER}-x86_64-linux-gnu.tar.gz"
        echo ${download_url}
        curl -L "$download_url" -o xtensa-esp-elf-x86_64-linux-gnu.tar.gz
        tar -xzf xtensa-esp-elf-x86_64-linux-gnu.tar.gz
        IDF_PATH=~/esp/xtensa-esp-elf/bin/
        export IDF_PATH

    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Build
      run: |
          IDF_PATH=~/esp/xtensa-esp-elf/bin/
          export CROSS_PREFIX=${IDF_PATH}/xtensa-esp32-elf-
          export __STDC_NO_ATOMICS__=1
          make -j$(getconf _NPROCESSORS_ONLN) CONFIG_WERROR=y CONFIG_UBSAN=y
    - name: Package static library
      run: |
        cd ${GITHUB_WORKSPACE}/build
        tar -czf quickjs-esp32s3-static-library.tar.gz libquickjs.a
        echo "Static library created"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: quickjs-esp32s3-static-library.tar.gz # 指定需要发布的文件
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub token 来创建 release        
